import logging as logger
import os
from inspect import isfunction
from pathlib import Path


class CmdHandler:
    def __init__(self, triggers: list or str = None, sub_handler: list or callable = None, autocompletion=None):
        self.triggers = triggers or (triggers if isinstance(triggers, list) else [triggers])
        self.sub_handler = sub_handler or []
        self.autocompletion = autocompletion

    @staticmethod
    def split(arr, cmd_lower: bool = False):
        if len(arr) > 0:
            return (
                arr[0].lower() if cmd_lower else arr[0],
                arr[1:] or [],
            )
        return ("", [])

    def tree(self):
        if isinstance(self.sub_handler, list) and self.sub_handler:
            tree_dict = {}

            for sub_handler in self.sub_handler:
                if isinstance(sub_handler, CmdHandler):
                    tree_dict[tuple(sub_handler.triggers)] = sub_handler.tree()
                else:
                    tree_dict[tuple(sub_handler.triggers)] = sub_handler.autocompletion

            return tree_dict
        return self.autocompletion

    def handle(self, s: list) -> bool:
        cmd, args = CmdHandler.split(s, True)

        if isfunction(self.sub_handler):
            return self.sub_handler(s)
        else:
            for handler in self.sub_handler:
                for trigger in handler.triggers:
                    if cmd == trigger:
                        return handler.handle(args)

        logger.warning("Unknown command, available commands:")
        print(self)
        return False

    def add(self, triggers, sub_handler=None, autocompletion=None):
        s = CmdHandler(triggers, sub_handler, autocompletion)
        self.sub_handler.append(s)
        return s

    def add_handler(self, handler):
        self.sub_handler.append(handler)
        return self

    def __str__(self) -> str:
        return str(self.tree())


def cmd_validate(cmd_arr, expected_len, fail_msg=None):
    if len(cmd_arr) >= expected_len:
        return True
    elif fail_msg:
        logger.warning(fail_msg)
    return False


def ensure_folder(folder: str or Path):
    try:
        if not isinstance(folder, Path):
            folder = Path(folder)

        if not folder.exists():
            os.makedirs(folder)

    except:
        return False
    return folder.exists()
