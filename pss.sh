#!/bin/bash
cd $(cd "$(dirname "$BASH_SOURCE")"; cd -P "$(dirname "$(readlink "$BASH_SOURCE" || echo .)")"; pwd)

SPIN='-\|/'

spin() {
    while true; do
        printf "\r>> [${SPIN:i++%${#SPIN}:1}] \033[0;33mPSS\033[0m ($pssmsg_python_version) is starting: $pssmsg"
        sleep 0.1
    done
}


if command -v python3.12 &>/dev/null; then
    python_version="python3.12"
else
    python_version="python3"
fi

pssmsg_python_version=$($python_version -V)
pssmsg="Initializing venv..."
spin &
SPIN_PID=$!

if [ ! -d ".pss-venv" ]; then
    $python_version -m venv .pss-venv
fi

source .pss-venv/bin/activate

kill $SPIN_PID
pssmsg="Installing/Updating requirements..."
spin &
SPIN_PID=$!

if [ -f "requirements.txt" ]; then
    $python_version -m pip install -r requirements.txt -U -q
fi

kill $SPIN_PID
clear

$python_version pss.py $@
deactivate
