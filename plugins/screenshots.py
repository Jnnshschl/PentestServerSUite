import logging as logger
import shutil
import subprocess
from io import BytesIO

import pywinctl as pwc
from colorama import Fore
from PIL import ImageGrab

TAG = f"[{Fore.LIGHTYELLOW_EX}Screenshots{Fore.RESET}]"


def add_cmd(pm, cmd):
    cmd.add(["screenshot"], os_update)


def os_update(args):
    try:
        if not shutil.which("xclip"):
            logger.error(f"{TAG} You need to install xclip for this plugin to work...")
            return

        win = pwc.getActiveWindow()

        if win:
            with BytesIO() as output:
                ImageGrab.grab(bbox=win.getClientFrame()).save(output, "png")
                output.seek(0)
                image_bytes = output.getvalue()

            process = subprocess.Popen(["xclip", "-selection", "clipboard", "-t", "image/png", "-i"], stdin=subprocess.PIPE)
            process.communicate(input=image_bytes)

            logger.info(f"{TAG} Screenshot copied to clipboard!")
    except Exception as ex:
        logger.error(f"{TAG} Failed to run recon scan: {ex}")
