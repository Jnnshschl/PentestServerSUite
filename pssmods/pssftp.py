import logging as logger
import threading
from pathlib import Path

from colorama import Fore
from pyftpdlib.authorizers import DummyAuthorizer
from pyftpdlib.handlers import FTPHandler
from pyftpdlib.servers import FTPServer


class PssFtpServer(FTPServer):
    def __init__(self, address: str, port: int, serve_folder: Path) -> None:
        handler = FTPHandler
        handler.authorizer = DummyAuthorizer()

        FTPServer.__init__(self, (address, port), handler)
        self.port = port
        self.serve_folder = serve_folder

        prev_logging_level = logger.getLogger().level
        logger.getLogger().setLevel(logger.WARNING)

        self.ftp_thread = threading.Thread(target=lambda s: s.serve_forever(), args=[self], daemon=True)
        self.ftp_thread.start()

        logger.getLogger().setLevel(prev_logging_level)
        logger.info(f"Started FTP server on {Fore.LIGHTYELLOW_EX}{address}:{port}{Fore.RESET}")

    def set_folder(self, folder: Path):
        self.serve_folder = folder

        try:
            self.handler.authorizer.remove_user("anonymous")
        except:
            pass

        self.handler.authorizer.add_anonymous(str(folder.absolute()))
