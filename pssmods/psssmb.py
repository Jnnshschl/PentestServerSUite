import threading
import logging as logger

from colorama import Fore
from impacket.smbserver import SimpleSMBServer


class PssSmbServer(SimpleSMBServer):
    def __init__(self, listenAddress="0.0.0.0", listenPort=445):
        SimpleSMBServer.__init__(self, listenAddress, listenPort)

    @staticmethod
    def create(address: str, port: int, no_smb2: bool = False):
        address_port = f"{address}:{port}"
        logger.info(
            f"Starting SMB server on {Fore.LIGHTYELLOW_EX}{address_port}{Fore.RESET}"
        )

        smb_server = PssSmbServer(address, port)
        smb_server.setSMB2Support(not no_smb2)
        smb_server.default_share = "NONE"

        smb_thread = threading.Thread(
            target=lambda smb_server: smb_server.start(), args=[smb_server], daemon=True
        )
        smb_thread.start()
        return smb_server, smb_thread
